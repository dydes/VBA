Sub 创建基础表()

'设置变量
    Dim rowmax As Integer, wb As Workbook, wbpath As String, wb1path As String, wb2path As String, wb3path As String, filpath As String, wbname As String, wb1name As String, wb2name As String, wb3name As String, sht As Worksheet, sht1name As String, sht2name As String, sht3name As String, sht4name As String'这里需要改
    
'变量赋值
	filpath = "D:\会通\1.数据报告\0.三十一中阶段报告分析"  '这里需要改
	wbpath = filpath & "\基础表.xlsx"
	wb1path = filpath & "\期中.xls"
	wb2path = filpath & "\期末.xls"
	wb3path = filpath & "\配置表.xlsx"
	wbname = "基础表"
	wb1name = "期中"  '这里需要改
	wb2name = "期末"  '这里需要改
	wb3name = "配置表"
	sht1name = "成绩排名"
	sht2name = "学生明细表"
	sht3name = "班级属性"
	sht4name = "一二本线"
	
'在指定路径新建基础表
	Set wb = Workbooks.Add
    Set sht = wb.Worksheets(1)
    With sht
        .Name = "1"
    End With
    wb.SaveAs wbpath
    ActiveWorkbook.Close
    
'打开指定路径的所有文件
    Workbooks.Open (wbpath)		'基础表
    Workbooks.Open (wb1path)	'考试1表
    Workbooks.Open (wb2path)	'考试2表
	Workbooks.Open (wb3path)	'配置表

'将所有成绩排名工作表逐个复制到基础表中
'打开文件夹
    ChDir filpath
'打开基础表、历次考试表、配置表，并复制相应的sheet
    Workbooks.Open Filename:= wbpath
'复制第1场考试成绩排名到基础表中
    Windows(wb1name & ".xls").Activate
    Sheets(sht1name).Select
    Sheets(sht1name).Copy Before:=Workbooks(wbname & ".xlsx").Sheets(1)
    Sheets(1).Name = wb1name
'复制第2场考试成绩排名到基础表中
    Windows(wb2name & ".xls").Activate
    Sheets(sht1name).Select
    Sheets(sht1name).Copy Before:=Workbooks(wbname & ".xlsx").Sheets(1)
    Sheets(1).Name = wb2name
'复制配置表内容到基础表中
	Windows(wb3name & ".xlsx").Activate
    Sheets(sht3name).Select
    Sheets(sht3name).Copy After:=Workbooks(wbname & ".xlsx").Sheets(2)
    Sheets(3).Name = sht3name
	Windows(wb3name & ".xlsx").Activate
    Sheets(sht4name).Select
    Sheets(sht4name).Copy After:=Workbooks(wbname & ".xlsx").Sheets(3)
    Sheets(4).Name = sht4name
	
'删除没啥用的表“1”
    Application.DisplayAlerts = False
    Sheets("1").Delete

'调整表顺序
    Sheets(wb1name).Select
    Sheets(wb1name).Move Before:=Sheets(wb2name)
'关闭考试1表   
    Windows(wb1name & ".xls").Activate
    ActiveWorkbook.Close savechanges:=False
'关闭考试2表
    Windows(wb2name & ".xls").Activate
    ActiveWorkbook.Close savechanges:=False
'关闭配置表
	Windows(wb3name & ".xlsx").Activate
    ActiveWorkbook.Close savechanges:=False
	
'删除标题行
	Windows(wbname & ".xlsx").Activate
	Sheets(wb1name).Select
	Rows("1:2").Select
    Selection.Delete Shift:=xlUp
    Sheets(wb2name).Select
    Rows("1:2").Select
    Selection.Delete Shift:=xlUp
	
'生成学生明细表
	Sheets(wb1name).Copy After:=Sheets(2)
    Sheets(3).Name = sht2name

'删除多于列（此次只分析语数外）
	Columns("M:Z").Select
    Selection.Delete Shift:=xlToLeft
	Columns("E:E").Select
    Selection.Delete Shift:=xlToLeft
	
'插入空白列
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("G:G").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("I:I").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("K:K").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("M:M").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("O:O").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("Q:Q").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove

'更改列标题
    Range("D1").Select
    ActiveCell.FormulaR1C1 = "期中总分"
	Range("E1").Select
    ActiveCell.FormulaR1C1 = "期末总分"
    Range("F1").Select
    ActiveCell.FormulaR1C1 = "期中总分级次"
    Range("G1").Select
    ActiveCell.FormulaR1C1 = "期末总分级次"
    Range("H1").Select
    ActiveCell.FormulaR1C1 = "期中语文"
    Range("I1").Select
    ActiveCell.FormulaR1C1 = "期末语文"
    Range("J1").Select
    ActiveCell.FormulaR1C1 = "期中语文级次"
    Range("K1").Select
    ActiveCell.FormulaR1C1 = "期末语文级次"
    Range("L1").Select
    ActiveCell.FormulaR1C1 = "期中数学"
    Range("M1").Select
    ActiveCell.FormulaR1C1 = "期末数学"
    Range("N1").Select
    ActiveCell.FormulaR1C1 = "期中数学级次"
    Range("O1").Select
    ActiveCell.FormulaR1C1 = "期末数学级次"
    Range("P1").Select
    ActiveCell.FormulaR1C1 = "期中英语"
    Range("Q1").Select
    ActiveCell.FormulaR1C1 = "期末英语"
    Range("R1").Select
    ActiveCell.FormulaR1C1 = "期中英语级次"
	Range("S1").Select
    ActiveCell.FormulaR1C1 = "期末英语级次"
	
'匹配期末考试相关数据
	rowmax = ActiveSheet.UsedRange.Rows.Count
	Sheets("学生明细表").Range("E2:E" & rowmax).Formula = "=VLOOKUP(A2,期末!A:L,4,FALSE)"
	Sheets("学生明细表").Range("G2:G" & rowmax).Formula = "=VLOOKUP(A2,期末!A:L,6,FALSE)"
	Sheets("学生明细表").Range("I2:I" & rowmax).Formula = "=VLOOKUP(A2,期末!A:L,7,FALSE)"
	Sheets("学生明细表").Range("K2:K" & rowmax).Formula = "=VLOOKUP(A2,期末!A:L,8,FALSE)"
	Sheets("学生明细表").Range("M2:M" & rowmax).Formula = "=VLOOKUP(A2,期末!A:L,9,FALSE)"
	Sheets("学生明细表").Range("O2:O" & rowmax).Formula = "=VLOOKUP(A2,期末!A:L,10,FALSE)"
	Sheets("学生明细表").Range("Q2:Q" & rowmax).Formula = "=VLOOKUP(A2,期末!A:L,11,FALSE)"
	Sheets("学生明细表").Range("S2:S" & rowmax).Formula = "=VLOOKUP(A2,期末!A:L,12,FALSE)"

'插入空白列
    Columns("F:G").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("J:J").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("M:N").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("Q:Q").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("T:U").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("X:X").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("AA:AB").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove

'更改列标题
    Range("F1").Select
    ActiveCell.FormulaR1C1 = "总分波动"
	Range("G1").Select
    ActiveCell.FormulaR1C1 = "总分差值"
    Range("J1").Select
    ActiveCell.FormulaR1C1 = "总分进退步"
    Range("M1").Select
    ActiveCell.FormulaR1C1 = "语文波动"
    Range("N1").Select
    ActiveCell.FormulaR1C1 = "语文差值"
    Range("Q1").Select
    ActiveCell.FormulaR1C1 = "语文进退步"
    Range("T1").Select
    ActiveCell.FormulaR1C1 = "数学波动"
    Range("U1").Select
    ActiveCell.FormulaR1C1 = "数学差值"
    Range("X1").Select
    ActiveCell.FormulaR1C1 = "数学进退步"
    Range("AA1").Select
    ActiveCell.FormulaR1C1 = "英语波动"
    Range("AB1").Select
    ActiveCell.FormulaR1C1 = "英语差值"
    Range("AE1").Select
    ActiveCell.FormulaR1C1 = "英语进退步"
	
'计算得分差值
	Sheets("学生明细表").Range("G2:G" & rowmax).Formula = "=E2-D2"
	Sheets("学生明细表").Range("N2:N" & rowmax).Formula = "=L2-K2"
	Sheets("学生明细表").Range("U2:U" & rowmax).Formula = "=S2-R2"
	Sheets("学生明细表").Range("AB2:AB" & rowmax).Formula = "=Z2-Y2"

'计算进退步
	Sheets("学生明细表").Range("J2:J" & rowmax).Formula = "=I2-H2"
	Sheets("学生明细表").Range("Q2:Q" & rowmax).Formula = "=P2-O2"
	Sheets("学生明细表").Range("X2:X" & rowmax).Formula = "=W2-V2"
	Sheets("学生明细表").Range("AE2:AE" & rowmax).Formula = "=AD2-AC2"
	
'计算得分波动
	Sheets("学生明细表").Range("F2:F" & rowmax).Formula = "=if(D2=E2,0,TEXT(AVERAGE(D2:E2)/STDEV.P(D2:E2),0.0))"
	Sheets("学生明细表").Range("M2:M" & rowmax).Formula = "=if(K2=L2,0,TEXT(AVERAGE(K2:L2)/STDEV.P(K2:L2),0.0))"
	Sheets("学生明细表").Range("T2:T" & rowmax).Formula = "=if(R2=S2,0,TEXT(AVERAGE(R2:S2)/STDEV.P(R2:S2),0.0))"
	Sheets("学生明细表").Range("AA2:AA" & rowmax).Formula = "=if(Y2=Z2,0,TEXT(AVERAGE(Y2:Z2)/STDEV.P(Y2:Z2),0.0))"

'插入空白列
    Columns("D:G").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
	
'更改列标题
    Range("D1").Select
    ActiveCell.FormulaR1C1 = "文理科"
	Range("E1").Select
    ActiveCell.FormulaR1C1 = "分层"
    Range("F1").Select
    ActiveCell.FormulaR1C1 = "进步标准"
    Range("G1").Select
    ActiveCell.FormulaR1C1 = "退步标准"

'计算进退步
	Sheets("学生明细表").Range("D2:D" & rowmax).Formula = "=VLOOKUP(C2,班级属性!A:E,2,FALSE)"
	Sheets("学生明细表").Range("E2:E" & rowmax).Formula = "=VLOOKUP(C2,班级属性!A:E,3,FALSE)"
	Sheets("学生明细表").Range("F2:F" & rowmax).Formula = "=VLOOKUP(C2,班级属性!A:E,4,FALSE)"
	Sheets("学生明细表").Range("G2:G" & rowmax).Formula = "=VLOOKUP(C2,班级属性!A:E,5,FALSE)"

'插入空白列
    Columns("O:P").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("X:Y").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("AG:AH").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove

'更改列标题
    Range("O1").Select
    ActiveCell.FormulaR1C1 = "总分是否进步"
	Range("P1").Select
    ActiveCell.FormulaR1C1 = "总分是否退步"
    Range("X1").Select
    ActiveCell.FormulaR1C1 = "语文是否进步"
    Range("Y1").Select
    ActiveCell.FormulaR1C1 = "语文是否退步"
	Range("AG1").Select
    ActiveCell.FormulaR1C1 = "数学是否进步"
    Range("AH1").Select
    ActiveCell.FormulaR1C1 = "数学是否退步"
	Range("AP1").Select
    ActiveCell.FormulaR1C1 = "英语是否进步"
    Range("AQ1").Select
    ActiveCell.FormulaR1C1 = "英语是否退步"
	
'判断是否进退步
	Sheets("学生明细表").Range("O2:O" & rowmax).Formula = "=IF(AND(N2>0,ABS(N2)>F2),1,0)"
	Sheets("学生明细表").Range("X2:X" & rowmax).Formula = "=IF(AND(W2>0,ABS(W2)>F2),1,0)"
	Sheets("学生明细表").Range("AG2:AG" & rowmax).Formula = "=IF(AND(AF2>0,ABS(AF2)>F2),1,0)"
	Sheets("学生明细表").Range("AP2:AP" & rowmax).Formula = "=IF(AND(AO2>0,ABS(AO2)>F2),1,0)"
	Sheets("学生明细表").Range("P2:P" & rowmax).Formula = "=IF(AND(N2<0,ABS(N2)>G2),1,0)"
	Sheets("学生明细表").Range("Y2:Y" & rowmax).Formula = "=IF(AND(W2<0,ABS(W2)>G2),1,0)"
	Sheets("学生明细表").Range("AH2:AH" & rowmax).Formula = "=IF(AND(AF2<0,ABS(AF2)>G2),1,0)"
	Sheets("学生明细表").Range("AQ2:AQ" & rowmax).Formula = "=IF(AND(AO2<0,ABS(AO2)>G2),1,0)"

'插入空白列	
    Columns("Q:S").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("AC:AE").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
    Columns("AO:AQ").Select
    Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
	
'更改列标题
    Range("Q1").Select
    ActiveCell.FormulaR1C1 = "总分一本线"
	Range("R1").Select
    ActiveCell.FormulaR1C1 = "总分二本线"
    Range("S1").Select
    ActiveCell.FormulaR1C1 = "期末总分上线"
    Range("AC1").Select
    ActiveCell.FormulaR1C1 = "语文一本线"
	Range("AD1").Select
    ActiveCell.FormulaR1C1 = "语文二本线"
    Range("AE1").Select
    ActiveCell.FormulaR1C1 = "期末语文上线"
	Range("AO1").Select
    ActiveCell.FormulaR1C1 = "数学一本线"
    Range("AP1").Select
    ActiveCell.FormulaR1C1 = "数学二本线"
    Range("AQ1").Select
    ActiveCell.FormulaR1C1 = "期末数学上线"
	Range("BA1").Select
    ActiveCell.FormulaR1C1 = "英语一本线"
    Range("BB1").Select
    ActiveCell.FormulaR1C1 = "英语二本线"
    Range("BC1").Select
    ActiveCell.FormulaR1C1 = "期末英语上线"
	
'判断上线情况
	Sheets("学生明细表").Range("Q2:Q" & rowmax).Formula = "=VLOOKUP(D2,一二本线!$A$2:$D$3,3,FALSE)"
	Sheets("学生明细表").Range("R2:R" & rowmax).Formula = "=VLOOKUP(D2,一二本线!$A$2:$D$3,4,FALSE)"
	Sheets("学生明细表").Range("S2:S" & rowmax).Formula = "=IF(I2>=Q2,""一本"",IF(I2>=R2,""二本"",""无""))"
	Sheets("学生明细表").Range("AC2:AC" & rowmax).Formula = "=VLOOKUP(D2,一二本线!$A$4:$D$5,3,FALSE)"
	Sheets("学生明细表").Range("AD2:AD" & rowmax).Formula = "=VLOOKUP(D2,一二本线!$A$4:$D$5,4,FALSE)"
	Sheets("学生明细表").Range("AE2:AE" & rowmax).Formula = "=IF(U2>=AC2,""一本"",IF(U2>=AD2,""二本"",""无""))"
	Sheets("学生明细表").Range("AO2:AO" & rowmax).Formula = "=VLOOKUP(D2,一二本线!$A$6:$D$7,3,FALSE)"
	Sheets("学生明细表").Range("AP2:AP" & rowmax).Formula = "=VLOOKUP(D2,一二本线!$A$6:$D$7,4,FALSE)"
	Sheets("学生明细表").Range("AQ2:AQ" & rowmax).Formula = "=IF(AG2>=AO2,""一本"",IF(AG2>=AP2,""二本"",""无""))"
	Sheets("学生明细表").Range("BA2:BA" & rowmax).Formula = "=VLOOKUP(D2,一二本线!$A$8:$D$9,3,FALSE)"
	Sheets("学生明细表").Range("BB2:BB" & rowmax).Formula = "=VLOOKUP(D2,一二本线!$A$8:$D$9,3,FALSE)"
	Sheets("学生明细表").Range("BC2:BC" & rowmax).Formula = "=IF(AS2>=BA2,""一本"",IF(AS2>=BB2,""二本"",""无""))"

'自适应宽度并调整格式
	Columns("A:BC").Select
    Columns("A:BC").EntireColumn.AutoFit
	Range("A1").Select
    Range(Selection, ActiveCell.SpecialCells(xlLastCell)).Select
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    With Selection.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeRight)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideVertical)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideHorizontal)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    Range("A1").Select
    Range(Selection, Selection.End(xlToRight)).Select
    With Selection.Interior
        .Pattern = xlSolid
        .PatternColorIndex = xlAutomatic
        .ThemeColor = xlThemeColorAccent5
        .TintAndShade = 0.799981688894314
        .PatternTintAndShade = 0
    End With
	
'完结撒花！*★,°*:.☆\(￣▽￣)/$:*.°★* 。 
	Msgbox "基础表整理完成！"

End Sub

